<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ì˜ìƒ ê¸°íšì•ˆ ì œì‘ ì›Œí¬í”Œë¡œìš° - PRO</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#FFF;color:#000;display:flex;height:100vh;overflow:hidden}
.sidebar{width:280px;background:#f8f8f8;border-right:2px solid #e0e0e0;overflow-y:auto;padding:20px 0}
.sidebar-header{padding:0 20px 20px;border-bottom:2px solid #A56744;margin-bottom:20px}
.sidebar-header h1{font-size:18px;font-weight:bold;color:#A56744}
.module-title{padding:10px 20px;background:#A56744;color:#FFF;font-weight:bold;font-size:13px}
.step-item{padding:10px 20px 10px 35px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:8px;border-left:3px solid transparent}
.step-item:hover{background:#e8e8e8}
.step-item.active{background:#fff;border-left-color:#A56744;font-weight:bold}
.main-content{flex:1;overflow-y:auto;padding:30px 50px}
.content-header{margin-bottom:30px;border-bottom:3px solid #A56744;padding-bottom:15px}
.content-header h2{font-size:24px;color:#A56744;margin-bottom:8px}
.content-header p{font-size:13px;color:#666}
.progress-bar{width:100%;height:5px;background:#e0e0e0;border-radius:3px;margin-bottom:20px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,#A56744,#8d5739);transition:.3s}
.progress-text{text-align:center;font-size:12px;color:#666;margin-top:5px}
.step-container{display:none}
.step-container.active{display:block}
.form-section{margin-bottom:30px}
.form-section h3{font-size:16px;margin-bottom:15px;color:#A56744;font-weight:bold}
.selection-group{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px}
.selection-button{padding:10px 20px;border:2px solid #A56744;background:#FFF;color:#000;border-radius:20px;cursor:pointer;transition:.3s;font-size:13px}
.selection-button:hover{background:#f5f5f5}
.selection-button.selected{background:#A56744;color:#FFF}
.input-field{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:6px;font-size:13px;font-family:inherit}
.input-field:focus{outline:none;border-color:#A56744}
textarea.input-field{min-height:120px;resize:vertical}
.input-with-button{display:flex;gap:10px}
.random-btn{padding:10px 18px;border:2px solid #A56744;background:#FFF;color:#000;border-radius:20px;cursor:pointer;font-size:14px;transition:.3s}
.random-btn:hover{background:#A56744;color:#FFF}
.btn{padding:10px 25px;border:none;background:#A56744;color:#000;border-radius:20px;cursor:pointer;font-size:14px;font-weight:bold;transition:.3s}
.btn:hover:not(:disabled){background:#8d5739}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-secondary{background:#FFF;color:#000;border:2px solid #A56744}
.btn-secondary:hover:not(:disabled){background:#f5f5f5}
.btn-generate{background:#4CAF50;color:#FFF}
.btn-generate:hover{background:#45a049}
.button-group{display:flex;gap:12px;flex-wrap:wrap}
.action-buttons{display:flex;justify-content:space-between;margin-top:40px;padding-top:20px;border-top:2px solid #e0e0e0}
.character-card,.act-section,.bg-card,.shot-card{border:2px solid #e0e0e0;border-radius:10px;padding:20px;margin-bottom:20px;background:#fafafa}
.character-card-header,.bg-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #A56744}
.card-title{font-size:16px;font-weight:bold;color:#A56744}
.remove-btn{padding:6px 14px;border:2px solid #d32f2f;background:#FFF;color:#d32f2f;border-radius:15px;cursor:pointer;font-size:12px;transition:.3s}
.remove-btn:hover{background:#d32f2f;color:#FFF}
.add-btn{width:100%;padding:12px;border:2px dashed #A56744;background:transparent;color:#A56744;border-radius:10px;cursor:pointer;font-weight:bold;margin-top:15px}
.add-btn:hover{background:#f5f5f5}
.toggle-group{display:flex;gap:10px;margin-bottom:15px}
.toggle-btn{padding:8px 16px;border:2px solid #A56744;background:#FFF;color:#000;border-radius:15px;cursor:pointer;transition:.3s}
.toggle-btn.active{background:#A56744;color:#FFF}
.checkbox-group{display:flex;flex-direction:column;gap:8px;margin-left:15px}
.checkbox-item{display:flex;align-items:center;gap:8px}
.anti-force-container{margin-top:15px;padding:15px;background:#fff;border-radius:8px;border:2px solid #e0e0e0}
.upload-area{border:3px dashed #A56744;border-radius:10px;padding:30px;text-align:center;background:#fafafa;cursor:pointer;transition:.3s;margin-bottom:15px}
.upload-area:hover{background:#f0f0f0}
.upload-area.dragover{background:#fff5e6}
.upload-area input[type="file"]{display:none}
.image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:15px;margin-top:20px}
.image-card{border:2px solid #e0e0e0;border-radius:10px;overflow:hidden;background:#fff;transition:.3s}
.image-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.1)}
.image-preview{width:100%;height:180px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative}
.image-preview img{max-width:100%;max-height:100%;object-fit:contain}
.image-label{padding:10px;background:#fafafa;font-size:12px;font-weight:bold;text-align:center;border-top:2px solid #e0e0e0}
.image-actions{padding:8px;display:flex;gap:6px;justify-content:center}
.icon-btn{padding:5px 10px;border:1px solid #A56744;background:#fff;color:#A56744;border-radius:5px;cursor:pointer;font-size:11px;transition:.3s}
.icon-btn:hover{background:#A56744;color:#fff}
.generating{position:relative}
.generating::after{content:"ìƒì„± ì¤‘...";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.7);color:#fff;padding:10px 20px;border-radius:8px;font-size:13px}
.accordion-item{border:2px solid #e0e0e0;border-radius:10px;overflow:hidden;margin-bottom:15px;background:#fff}
.accordion-header{background:#f5f5f5;padding:15px 20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:.3s}
.accordion-header:hover{background:#ebebeb}
.accordion-header.active{background:#A56744;color:#fff}
.accordion-title{font-size:15px;font-weight:bold;display:flex;align-items:center;gap:12px}
.accordion-arrow{font-size:18px;transition:transform .3s}
.accordion-header.active .accordion-arrow{transform:rotate(180deg)}
.accordion-content{display:none;padding:20px;background:#fafafa}
.accordion-content.active{display:block}
.scene-accordion{border:2px solid #e0e0e0;border-radius:10px;margin-bottom:15px;overflow:hidden}
.scene-header{background:#f5f5f5;padding:12px 18px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:.3s}
.scene-header:hover{background:#ebebeb}
.scene-header.active{background:#A56744;color:#fff}
.scene-content{display:none;padding:15px;background:#fafafa}
.scene-content.active{display:block}
.tone-section{background:#fff5e6;border:2px solid #A56744;border-radius:10px;padding:20px;margin-bottom:25px}
.tone-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.switch{position:relative;width:50px;height:25px;background:#ccc;border-radius:15px;cursor:pointer;transition:.3s}
.switch.active{background:#4CAF50}
.switch-slider{position:absolute;top:3px;left:3px;width:19px;height:19px;background:#fff;border-radius:50%;transition:.3s}
.switch.active .switch-slider{transform:translateX(25px)}
.prompt-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px}
.prompt-section{display:flex;flex-direction:column}
.prompt-label{font-size:12px;font-weight:bold;margin-bottom:5px;color:#A56744}
.prompt-input{padding:8px;border:2px solid #e0e0e0;border-radius:5px;font-size:12px;font-family:inherit;resize:vertical;min-height:50px}
.prompt-input:focus{outline:none;border-color:#A56744}
.key-image-preview{width:100%;height:350px;border:2px solid #e0e0e0;border-radius:8px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;margin-bottom:12px;cursor:pointer;position:relative;overflow:hidden}
.key-image-preview img{max-width:100%;max-height:100%;object-fit:contain}
.auto-prompt{background:#f0f0f0;padding:12px;border-radius:6px;margin-bottom:12px;font-size:11px;color:#333;border-left:4px solid #4CAF50}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:2000;justify-content:center;align-items:center}
.modal.active{display:flex}
.modal-content{max-width:95%;max-height:95%;position:relative}
.modal-content img{max-width:100%;max-height:90vh;object-fit:contain}
.modal-close{position:absolute;top:-40px;right:0;font-size:36px;color:#fff;cursor:pointer}
.save-status{position:fixed;top:20px;right:20px;padding:10px 20px;background:#4CAF50;color:white;border-radius:20px;font-size:12px;opacity:0;transition:.3s;z-index:1000}
.save-status.show{opacity:1}
.note{padding:12px;background:#fff5e6;border-left:4px solid #A56744;margin-bottom:15px;font-size:12px;color:#666}
.hidden{display:none}
.char-counter{text-align:right;font-size:11px;color:#999;margin-top:5px}
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:9999}
.loading-overlay.active{display:flex}
.loading-content{background:white;padding:40px;border-radius:16px;text-align:center}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #A56744;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.hero-section{text-align:center;margin-bottom:50px;padding:35px 20px;background:linear-gradient(135deg,#A56744,#8d5739);border-radius:14px;color:white}
.hero-title{font-size:32px;font-weight:bold;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
.hero-subtitle{font-size:16px;opacity:.95}
.input-row{display:flex;gap:12px;margin-bottom:15px}
.input-row>div{flex:1}
label{display:block;margin-bottom:6px;font-weight:500;font-size:12px}
</style>
</head>
<body>
<!-- ì‚¬ì´ë“œë°” -->
<div class="sidebar">
<div class="sidebar-header">
<h1>ì˜ìƒ ê¸°íšì•ˆ ì œì‘ PRO</h1>
<div style="margin-top:15px;padding:10px;background:#fff5e6;border-radius:8px;border:1px solid #A56744">
<label style="font-size:11px;font-weight:bold;color:#A56744;display:block;margin-bottom:5px">ğŸ¤– Gemini API Key</label>
<input type="text" id="apiKey" class="input-field" placeholder="AIza... ë¡œ ì‹œì‘í•˜ëŠ” í‚¤ ì…ë ¥" style="font-size:11px;padding:6px;margin-bottom:5px" oninput="saveApiKey()">
<button onclick="testApiKey()" style="width:100%;padding:5px;background:#4CAF50;color:#fff;border:none;border-radius:5px;font-size:10px;cursor:pointer;margin-bottom:5px">âœ“ API í‚¤ í…ŒìŠ¤íŠ¸</button>
<div id="modelStatus" style="font-size:9px;color:#4CAF50;font-weight:bold;margin-bottom:5px;display:none">
âœ… ì—°ê²° ì„±ê³µ! (gemini-1.5-flash)
</div>
<div style="font-size:9px;color:#666;line-height:1.4">
<a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#A56744;text-decoration:underline">ğŸ“ í‚¤ ë°œê¸‰ ë°›ê¸°</a><br>
* í‚¤ëŠ” ë¡œì»¬ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤<br>
* v1 API (ì•ˆì • ë²„ì „) ì‚¬ìš©<br>
* ìµœì‹  ëª¨ë¸ ìë™ ì„ íƒ<br>
* 2.0-flash-exp â†’ 1.5-flash-latest â†’ 1.5-pro-latest
</div>
</div>
</div>
<div class="module-title">Module 1 â€” ìŠ¤í† ë¦¬</div>
<div class="step-item active" data-step="1"><span>ğŸ¬</span><span>1. ì œì‘ í˜•ì‹</span></div>
<div class="step-item" data-step="2"><span>âœï¸</span><span>2. ì¤„ê±°ë¦¬</span></div>
<div class="step-item" data-step="3"><span>ğŸ‘¥</span><span>3. ìºë¦­í„°</span></div>
<div class="step-item" data-step="4"><span>ğŸ“–</span><span>4. 5ë§‰ êµ¬ì¡°</span></div>
<div class="module-title">Module 2 â€” Visual Assets</div>
<div class="step-item" data-step="5"><span>ğŸ¨</span><span>5. ì£¼ì¸ê³µ ì‹œíŠ¸</span></div>
<div class="step-item" data-step="6"><span>ğŸ–¼ï¸</span><span>6. ì¶”ê°€ ìºë¦­í„°</span></div>
<div class="step-item" data-step="7"><span>ğŸï¸</span><span>7. ë°°ê²½</span></div>
<div class="module-title">Module 3 â€” íì‹œíŠ¸</div>
<div class="step-item" data-step="8"><span>ğŸ”‘</span><span>8. KEY ì´ë¯¸ì§€</span></div>
<div class="module-title">Module 4 â€” ê¸°íšì•ˆ</div>
<div class="step-item" data-step="9"><span>ğŸ“„</span><span>9. ì´ì •ë¦¬</span></div>
</div>

<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div class="main-content">
<div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:11%"></div></div>
<div class="progress-text" id="progressText">1/9 ë‹¨ê³„ (11%)</div>

<!-- 1ë‹¨ê³„ -->
<div class="step-container active" data-step="1">
<div class="content-header"><h2>1ë‹¨ê³„: ì œì‘ í˜•ì‹ ì„ íƒ</h2><p>ì˜ìƒì˜ ê¸°ë³¸ ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤</p></div>
<div class="form-section"><h3>(1) ì œì‘ í˜•íƒœ</h3>
<div class="selection-group" id="productionType">
<button class="selection-button" data-value="ì˜í™”">ì˜í™”</button>
<button class="selection-button" data-value="2D ì• ë‹ˆë©”ì´ì…˜">2D ì• ë‹ˆë©”ì´ì…˜</button>
<button class="selection-button" data-value="3D ì• ë‹ˆë©”ì´ì…˜">3D ì• ë‹ˆë©”ì´ì…˜</button>
</div></div>
<div class="form-section"><h3>(2) ì˜ìƒ ê¸¸ì´</h3>
<div class="selection-group" id="videoLength">
<button class="selection-button" data-value="29ì´ˆ">29ì´ˆ</button>
<button class="selection-button" data-value="1ë¶„">1ë¶„</button>
<button class="selection-button" data-value="1ë¶„ 30ì´ˆ">1ë¶„ 30ì´ˆ</button>
<button class="selection-button" data-value="3ë¶„">3ë¶„</button>
<button class="selection-button" data-value="5ë¶„">5ë¶„</button>
<button class="selection-button" data-value="8ë¶„">8ë¶„</button>
<button class="selection-button" data-value="10ë¶„">10ë¶„</button>
<button class="selection-button" data-value="30ë¶„">30ë¶„</button>
</div></div>
<div class="form-section"><h3>(3) ì„¸ê³„ê´€</h3>
<div class="selection-group" id="worldview">
<button class="selection-button" data-value="í•œêµ­">í•œêµ­</button>
<button class="selection-button" data-value="ì¤‘êµ­">ì¤‘êµ­</button>
<button class="selection-button" data-value="ì¼ë³¸">ì¼ë³¸</button>
<button class="selection-button" data-value="í™ì½©">í™ì½©</button>
<button class="selection-button" data-value="ìœ ëŸ½">ìœ ëŸ½</button>
<button class="selection-button" data-value="ë¯¸êµ­">ë¯¸êµ­</button>
<button class="selection-button" data-value="ì˜êµ­">ì˜êµ­</button>
<button class="selection-button" data-value="íŒíƒ€ì§€">íŒíƒ€ì§€</button>
<button class="selection-button" data-value="ë‹¤í¬íŒíƒ€ì§€">ë‹¤í¬íŒíƒ€ì§€</button>
<button class="selection-button" data-value="ë¡œë§¨ìŠ¤íŒíƒ€ì§€">ë¡œë§¨ìŠ¤íŒíƒ€ì§€</button>
<button class="selection-button" data-value="ì•„ì¹´ë°ë¯¸ë¬¼">ì•„ì¹´ë°ë¯¸ë¬¼</button>
<button class="selection-button" data-value="í‚¤ì¦ˆ">í‚¤ì¦ˆ</button>
</div></div>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" disabled>ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(2)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 2ë‹¨ê³„ -->
<div class="step-container" data-step="2">
<div class="content-header"><h2>2ë‹¨ê³„: ì œëª© / ì¤„ê±°ë¦¬ / ì„¸ê³„ê´€</h2></div>
<div class="form-section"><h3>(1) ì œëª©</h3>
<div class="input-with-button">
<input type="text" class="input-field" id="title" placeholder="ì‘í’ˆ ì œëª©" oninput="saveData()">
<button class="random-btn" onclick="generateTitle()">ğŸ²</button>
</div></div>
<div class="form-section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h3>(2) ì¤„ê±°ë¦¬</h3>
<button class="btn btn-generate" onclick="generatePlot()">ğŸ¤– AI ìƒì„±</button>
</div>
<textarea class="input-field" id="plot" placeholder="ì¤„ê±°ë¦¬ ì…ë ¥..." maxlength="5000" oninput="updateCounter('plot','plotCount',5000)"></textarea>
<div class="char-counter" id="plotCount">0/5000</div></div>
<div class="form-section">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h3>(3) ì„¸ê³„ê´€</h3>
<button class="btn btn-generate" onclick="generateWorld()">ğŸ¤– AI ìƒì„±</button>
</div>
<textarea class="input-field" id="worldDesc" placeholder="ì„¸ê³„ê´€ ì…ë ¥..." maxlength="5000" oninput="updateCounter('worldDesc','worldCount',5000)"></textarea>
<div class="char-counter" id="worldCount">0/5000</div></div>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" onclick="goToStep(1)">ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(3)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 3ë‹¨ê³„: ìºë¦­í„° -->
<div class="step-container" data-step="3">
<div class="content-header"><h2>3ë‹¨ê³„: ìºë¦­í„° ë¹Œë“œì—…</h2><p>ì£¼ìš” ìºë¦­í„°ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤</p></div>
<div id="charactersContainer"></div>
<button class="add-btn" onclick="addCharacter()">+ ìºë¦­í„° ì¶”ê°€</button>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" onclick="goToStep(2)">ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(4)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 4ë‹¨ê³„: 5ë§‰ êµ¬ì¡° -->
<div class="step-container" data-step="4">
<div class="content-header"><h2>4ë‹¨ê³„: 5ë§‰ êµ¬ì¡°</h2><p>AIê°€ ìë™ìœ¼ë¡œ 5ë§‰ êµ¬ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p></div>
<button class="btn btn-generate" onclick="generate5Acts()" style="margin-bottom:20px">ğŸ² ìë™ ìƒì„±</button>
<div class="act-section"><h4>â‘  ë°œë‹¨ (Setup)</h4>
<textarea class="input-field" id="act1" placeholder="í›„í‚¹ í¬í•¨..." maxlength="2000" oninput="saveData()"></textarea></div>
<div class="act-section"><h4>â‘¡ ì „ê°œ (Development)</h4>
<textarea class="input-field" id="act2" placeholder="ì „ê°œ..." maxlength="2000" oninput="saveData()"></textarea></div>
<div class="act-section"><h4>â‘¢ ìœ„ê¸° (Crisis)</h4>
<textarea class="input-field" id="act3" placeholder="ìœ„ê¸°..." maxlength="2000" oninput="saveData()"></textarea></div>
<div class="act-section"><h4>â‘£ ì ˆì • (Climax)</h4>
<textarea class="input-field" id="act4" placeholder="ë°˜ì „ í¬í•¨..." maxlength="2000" oninput="saveData()"></textarea></div>
<div class="act-section"><h4>â‘¤ ê²°ë§ (Resolution)</h4>
<textarea class="input-field" id="act5" placeholder="ê²°ë§..." maxlength="2000" oninput="saveData()"></textarea></div>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" onclick="goToStep(3)">ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(5)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 5ë‹¨ê³„: ì£¼ì¸ê³µ ì‹œíŠ¸ -->
<div class="step-container" data-step="5">
<div class="content-header"><h2>5ë‹¨ê³„: ì£¼ì¸ê³µ ìºë¦­í„° ì‹œíŠ¸</h2><p>ì¼ê´€ëœ ë¹„ì£¼ì–¼ ìì‚°ì„ ìƒì„±í•©ë‹ˆë‹¤</p></div>
<div class="note">â€» ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ í¬ì¦ˆ 4ì¢…, í‘œì • 7ì¢…ì´ ìë™ ìƒì„±ë©ë‹ˆë‹¤</div>
<div class="form-section"><h3>ìºë¦­í„° ì´ë¦„</h3>
<input type="text" class="input-field" id="mainCharName" placeholder="ì£¼ì¸ê³µ ì´ë¦„" readonly></div>
<div class="form-section"><h3>ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€</h3>
<div class="upload-area" id="mainUpload">
<div style="font-size:40px">ğŸ“·</div>
<p>í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ì•¤ë“œë¡­</p>
<input type="file" accept="image/*" id="mainFile">
</div>
<div id="mainPreview" class="hidden" style="text-align:center;margin-top:10px">
<img id="mainImg" style="max-width:250px;border-radius:8px">
</div></div>
<button class="btn btn-generate" onclick="generateMainChar()">ğŸ² ìºë¦­í„° ì‹œíŠ¸ ìƒì„±</button>
<div class="image-grid" id="mainGrid"></div>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" onclick="goToStep(4)">ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadAllImages('main')">ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(6)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 6ë‹¨ê³„: ì¶”ê°€ ìºë¦­í„° -->
<div class="step-container" data-step="6">
<div class="content-header"><h2>6ë‹¨ê³„: ì¶”ê°€ ìºë¦­í„° ì‹œíŠ¸</h2></div>
<div id="subCharsContainer"></div>
<button class="add-btn" onclick="addSubCharacter()">+ ìºë¦­í„° ì¶”ê°€</button>
<div class="action-buttons">
<div class="button-group">
<button class="btn btn-secondary" onclick="goToStep(5)">ì´ì „</button>
<button class="btn btn-secondary" onclick="alert('ê±´ë„ˆë›°ê¸°')">ê±´ë„ˆë›°ê¸°</button>
</div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(7)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 7ë‹¨ê³„: ë°°ê²½ -->
<div class="step-container" data-step="7">
<div class="content-header"><h2>7ë‹¨ê³„: ê¸°ë³¸ ë°°ê²½ ì œì‘</h2><p>6ê°œ ì‹œì ì˜ ë°°ê²½ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p></div>
<div class="note">â€» ë“œë¡ ë·°/íƒ‘ë‹¤ìš´/ì•„ì´ë ˆë²¨/ë¡œìš°ì•µê¸€/í´ë¡œì¦ˆì—…/ìµìŠ¤íŠ¸ë¦¼ ìë™ ìƒì„±</div>
<div id="backgroundsContainer"></div>
<button class="add-btn" onclick="addBackground()">+ ë°°ê²½ ì¶”ê°€</button>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" onclick="goToStep(6)">ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(8)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 8ë‹¨ê³„: íì‹œíŠ¸ -->
<div class="step-container" data-step="8">
<div class="content-header"><h2>8ë‹¨ê³„: íì‹œíŠ¸ ë° KEY ì´ë¯¸ì§€</h2></div>
<div class="tone-section">
<div class="tone-header">
<div><strong>ğŸ¨ Tone & Manner Reference</strong></div>
<div style="display:flex;align-items:center;gap:10px">
<span id="toneLabel">Auto Match: OFF</span>
<div class="switch" id="toneToggle"><div class="switch-slider"></div></div>
</div></div>
<div class="upload-area" id="toneUpload">
<div style="font-size:32px">ğŸ­</div>
<p>í†¤ì•¤ë§¤ë„ˆ ë ˆí¼ëŸ°ìŠ¤ ì—…ë¡œë“œ</p>
<input type="file" accept="image/*" id="toneFile">
</div>
<div id="tonePreview" class="hidden" style="text-align:center;margin-top:10px">
<img id="toneImg" style="max-width:250px;border-radius:8px">
</div></div>
<div class="note">â€» 10ì´ˆ ë‹¨ìœ„ ì”¬ ìë™ ë¶„í• , ê° ìƒ·ì— KEY ì´ë¯¸ì§€ ìƒì„±</div>
<div class="button-group" style="margin-bottom:20px">
<button class="btn btn-generate" onclick="autoGenCuesheet()">ğŸ² íì‹œíŠ¸ ìë™ ìƒì„±</button>
<button class="btn btn-secondary" onclick="addScene()">+ ì”¬ ì¶”ê°€</button>
</div>
<div id="scenesContainer"></div>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" onclick="goToStep(7)">ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadWord()">ì›Œë“œ ë‹¤ìš´ë¡œë“œ</button>
<button class="btn" onclick="goToStep(9)">ë‹¤ìŒ</button>
</div></div>
</div>

<!-- 9ë‹¨ê³„: ê¸°íšì•ˆ ì´ì •ë¦¬ -->
<div class="step-container" data-step="9">
<div class="hero-section">
<div class="hero-title">HOOKìœ¼ë¡œ ì¡ê³ , Loglineìœ¼ë¡œ ì„¤ë“í•©ë‹ˆë‹¤</div>
<div class="hero-subtitle">ìµœì¢… ê¸°íšì•ˆ ì™„ì„±</div>
</div>
<div class="content-header"><h2>9ë‹¨ê³„: ê¸°íšì•ˆ ì´ì •ë¦¬</h2></div>
<div class="note">â€» 1~5ë²ˆì€ AI ìë™ ìƒì„±, 6ë²ˆì€ ì§ì ‘ ì‘ì„±</div>
<button class="btn btn-generate" onclick="autoGenPlan()" style="margin-bottom:20px">ğŸ¤– AI ìë™ ìƒì„± (1~5ë²ˆ)</button>
<div class="accordion-item">
<div class="accordion-header" onclick="toggleAcc(0)">
<div class="accordion-title"><span>ğŸ£</span><span>1. Hook (1ì¤„)</span></div>
<span class="accordion-arrow">â–¼</span>
</div>
<div class="accordion-content">
<textarea class="input-field" id="hook" placeholder="Hook..." maxlength="200" oninput="saveData()"></textarea>
<div class="char-counter" id="hookCount">0/200</div>
</div></div>
<div class="accordion-item">
<div class="accordion-header" onclick="toggleAcc(1)">
<div class="accordion-title"><span>ğŸ“</span><span>2. Logline (3ì¤„)</span></div>
<span class="accordion-arrow">â–¼</span>
</div>
<div class="accordion-content">
<textarea class="input-field" id="logline" placeholder="Logline..." maxlength="500" oninput="saveData()"></textarea>
<div class="char-counter" id="loglineCount">0/500</div>
</div></div>
<div class="accordion-item">
<div class="accordion-header" onclick="toggleAcc(2)">
<div class="accordion-title"><span>ğŸ“–</span><span>3. Synopsis</span></div>
<span class="accordion-arrow">â–¼</span>
</div>
<div class="accordion-content">
<textarea class="input-field" id="synopsis" placeholder="Synopsis..." maxlength="1500" oninput="saveData()" style="min-height:200px"></textarea>
</div></div>
<div class="accordion-item">
<div class="accordion-header" onclick="toggleAcc(3)">
<div class="accordion-title"><span>ğŸ“Š</span><span>4. ìºë¦­í„° ì•„ì¹˜</span></div>
<span class="accordion-arrow">â–¼</span>
</div>
<div class="accordion-content">
<textarea class="input-field" id="charArch" placeholder="ìºë¦­í„° ë³€í™”..." maxlength="1000" oninput="saveData()"></textarea>
</div></div>
<div class="accordion-item">
<div class="accordion-header" onclick="toggleAcc(4)">
<div class="accordion-title"><span>ğŸ’°</span><span>5. ì‹œì¥ì„±/íƒ€ê²Ÿ/ê²½ìŸì‘</span></div>
<span class="accordion-arrow">â–¼</span>
</div>
<div class="accordion-content">
<textarea class="input-field" id="market" placeholder="ì‹œì¥ ë¶„ì„..." maxlength="1000" oninput="saveData()"></textarea>
</div></div>
<div class="accordion-item">
<div class="accordion-header" onclick="toggleAcc(5)">
<div class="accordion-title"><span>ğŸ¬</span><span>6. ê°ë…ì˜ ì˜ë„ (ì§ì ‘ ì‘ì„±)</span></div>
<span class="accordion-arrow">â–¼</span>
</div>
<div class="accordion-content">
<p style="color:#d32f2f;margin-bottom:10px;font-weight:bold">â€» ì§ì ‘ ì‘ì„± (5000ì)</p>
<textarea class="input-field" id="director" placeholder="ê°ë…ì˜ ì˜ë„..." maxlength="5000" oninput="updateCounter('director','directorCount',5000)" style="min-height:300px"></textarea>
<div class="char-counter" id="directorCount">0/5000</div>
</div></div>
<div class="action-buttons">
<div class="button-group"><button class="btn btn-secondary" onclick="goToStep(8)">ì´ì „</button></div>
<div class="button-group">
<button class="btn btn-secondary" onclick="downloadFinal()">ğŸ“¥ ìµœì¢… ê¸°íšì•ˆ (ì „ì²´ í†µí•©)</button>
<button class="btn" onclick="alert('ì™„ë£Œ!')">ì™„ë£Œ</button>
</div></div>
</div>

</div>

<!-- ëª¨ë‹¬ -->
<div class="modal" id="modal">
<div class="modal-content">
<span class="modal-close" onclick="closeModal()">&times;</span>
<img id="modalImg">
</div></div>

<!-- ë¡œë”© -->
<div class="loading-overlay" id="loading">
<div class="loading-content">
<div class="spinner"></div>
<h3 style="color:#A56744;margin-bottom:10px">ìƒì„± ì¤‘...</h3>
<p style="color:#666">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
</div></div>

<!-- ì €ì¥ ìƒíƒœ -->
<div class="save-status" id="saveStatus">ìë™ ì €ì¥ë¨</div>

<script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
let currentStep=1;
let data={
step1:{prodType:'',vidLen:'',world:''},
step2:{title:'',plot:'',worldDesc:''},
step3:{chars:[]},
step4:{act1:'',act2:'',act3:'',act4:'',act5:''},
step5:{mainChar:{name:'',ref:null,imgs:{}}},
step6:{subChars:[]},
step7:{bgs:[]},
step8:{tone:{id:null,data:null,match:false},scenes:[]},
step9:{hook:'',logline:'',synopsis:'',charArch:'',market:'',director:''}
};
let charCounter=0,subCharCounter=0,bgCounter=0,sceneCounter=0,shotCounter=0;
let apiKey='';

// Gemini API ëª¨ë¸ ëª©ë¡ (ìš°ì„ ìˆœìœ„ ìˆœì„œ - ìµœì‹  ë²„ì „)
const GEMINI_MODELS=[
'gemini-2.0-flash-exp',      // 2.0 ì‹¤í—˜ ë²„ì „ (ìµœì‹ , ê°€ì¥ ë¹ ë¦„)
'gemini-1.5-flash-latest',   // 1.5 Flash ìµœì‹  ì•ˆì • ë²„ì „
'gemini-1.5-pro-latest',     // 1.5 Pro ìµœì‹  ì•ˆì • ë²„ì „ (ê³ ì„±ëŠ¥)
'gemini-1.5-flash',          // 1.5 Flash ê¸°ë³¸
'gemini-1.5-pro',            // 1.5 Pro ê¸°ë³¸
'gemini-1.0-pro-latest',     // 1.0 Pro ìµœì‹ 
'gemini-pro'                 // ë ˆê±°ì‹œ ëª¨ë¸
];
let currentModelIndex=0;

const CHAR_POSES=[{id:'front',label:'ì•'},{id:'back',label:'ë’¤'},{id:'side',label:'ì˜†'},{id:'sit',label:'ì•‰ìŒ'}];
const CHAR_EXPRS=[{id:'neutral',label:'Neutral'},{id:'happy',label:'Happy'},{id:'angry',label:'Angry'},{id:'sad',label:'Sad'},{id:'surprised',label:'Surprised'},{id:'flustered',label:'Flustered'},{id:'laugh',label:'Laughing'}];
const BG_VIEWS=[{id:'drone',label:'ë“œë¡ ë·°'},{id:'topdown',label:'íƒ‘ë‹¤ìš´ë·°'},{id:'eye',label:'ì•„ì´ë ˆë²¨ë·°'},{id:'low',label:'ë¡œìš°ì•µê¸€ë·°'},{id:'close',label:'í´ë¡œì¦ˆì—…ë·°'},{id:'extreme',label:'ìµìŠ¤íŠ¸ë¦¼ë·°'}];

function init(){
loadData();
loadApiKey();
setupButtons();
setupSidebar();
setupUploads();
updateProgress();
document.getElementById('mainCharName').value='ì£¼ì¸ê³µ';
addCharacter();
}

function saveApiKey(){
apiKey=document.getElementById('apiKey').value;
localStorage.setItem('geminiApiKey',apiKey);
}

function loadApiKey(){
const saved=localStorage.getItem('geminiApiKey');
if(saved){
apiKey=saved;
document.getElementById('apiKey').value=saved;
}
}

async function testApiKey(){
const btn=event.target;
const originalText=btn.textContent;
btn.disabled=true;
btn.textContent='í…ŒìŠ¤íŠ¸ ì¤‘...';
btn.style.background='#999';

const testPrompt='ì•ˆë…•í•˜ì„¸ìš”. ì´ê²ƒì€ API ì—°ê²° í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤. "ì—°ê²° ì„±ê³µ"ì´ë¼ê³  ì§§ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”.';
const result=await callGeminiAPI(testPrompt);

if(result){
const modelName=GEMINI_MODELS[currentModelIndex];
btn.style.background='#4CAF50';
btn.textContent='âœ“ ì—°ê²° ì„±ê³µ!';
const statusDiv=document.getElementById('modelStatus');
statusDiv.textContent='âœ… ì—°ê²° ì„±ê³µ! ('+modelName+')';
statusDiv.style.display='block';
alert('âœ… API í‚¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤!\n\nì‚¬ìš© ëª¨ë¸: '+modelName+'\n\nì‘ë‹µ: '+result.substring(0,100));
setTimeout(()=>{
btn.textContent=originalText;
btn.disabled=false;
},3000);
}else{
btn.style.background='#d32f2f';
btn.textContent='âœ— ì—°ê²° ì‹¤íŒ¨';
setTimeout(()=>{
btn.style.background='#4CAF50';
btn.textContent=originalText;
btn.disabled=false;
},3000);
}
}

async function callGeminiAPI(prompt,retryCount=0){
if(!apiKey||apiKey.trim()===''){
alert('âš ï¸ Gemini API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n1. https://aistudio.google.com/app/apikey ì ‘ì†\n2. API í‚¤ ìƒì„±\n3. ì‚¬ì´ë“œë°” ìƒë‹¨ì— ì…ë ¥');
return null;
}

// í˜„ì¬ ì‹œë„í•  ëª¨ë¸ ì„ íƒ
const modelName=GEMINI_MODELS[currentModelIndex];
const apiUrl=`https://generativelanguage.googleapis.com/v1/models/${modelName}:generateContent`;

try{
const requestBody={
contents:[{
parts:[{text:prompt}]
}]
};
console.log('ğŸ¤– Gemini API ìš”ì²­ ì‹œì‘...');
console.log('ğŸ“ API ë²„ì „: v1 (ì•ˆì • ë²„ì „)');
console.log('ğŸ¯ ëª¨ë¸ëª…:',modelName);
console.log('ğŸ“ URL:',apiUrl);
console.log('ğŸ”‘ API Key (ì• 10ì):', apiKey.substring(0,10)+'...');
console.log('ğŸ“ í”„ë¡¬í”„íŠ¸ ê¸¸ì´:',prompt.length,'ì');

const response=await fetch(`${apiUrl}?key=${apiKey}`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify(requestBody)
});

console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:',response.status,response.statusText);

if(!response.ok){
const errorText=await response.text();
console.error('âŒ ì—ëŸ¬ ì‘ë‹µ:',errorText);
let errorMsg='API í˜¸ì¶œ ì‹¤íŒ¨';
let shouldRetry=false;

try{
const error=JSON.parse(errorText);
console.error('âŒ íŒŒì‹±ëœ ì—ëŸ¬:',error);
errorMsg=error.error?.message||JSON.stringify(error);

// ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš° ë‹¤ìŒ ëª¨ë¸ ì‹œë„
if(errorMsg.includes('not found')||errorMsg.includes('not supported')||response.status===404){
if(currentModelIndex<GEMINI_MODELS.length-1){
console.log('âš ï¸ ëª¨ë¸ '+modelName+' ì‚¬ìš© ë¶ˆê°€. ë‹¤ìŒ ëª¨ë¸ ì‹œë„...');
currentModelIndex++;
return await callGeminiAPI(prompt,retryCount+1);
}else{
errorMsg='âŒ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.\n\nì‹œë„í•œ ëª¨ë¸:\n'+GEMINI_MODELS.join('\n')+'\n\nAPI í‚¤ê°€ Gemini APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€\nGoogle AI Studioì—ì„œ í™•ì¸í•˜ì„¸ìš”.';
}
}else if(errorMsg.includes('API_KEY_INVALID')||errorMsg.includes('invalid')){
errorMsg='âŒ API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì…ë ¥í•œ í‚¤: '+apiKey.substring(0,10)+'...\n\n1. í‚¤ë¥¼ ë‹¤ì‹œ ë³µì‚¬\n2. ê³µë°± ì—†ì´ ë¶™ì—¬ë„£ê¸°\n3. ë‹¤ì‹œ í…ŒìŠ¤íŠ¸';
}else if(errorMsg.includes('API key not valid')){
errorMsg='âŒ API í‚¤ê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n1. https://aistudio.google.com/app/apikey ì ‘ì†\n2. ìƒˆ API í‚¤ ìƒì„±\n3. ìƒì„±ëœ í‚¤ ë³µì‚¬í•´ì„œ ì‚¬ìš©';
}else if(errorMsg.includes('PERMISSION_DENIED')){
errorMsg='âŒ API ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n\ní•´ê²°ë°©ë²•:\n1. Google AI Studioì—ì„œ ìƒˆ API í‚¤ ìƒì„±\n2. https://aistudio.google.com/app/apikey\n3. ìƒì„±ëœ í‚¤ë¡œ ë‹¤ì‹œ ì‹œë„';
}else if(errorMsg.includes('QUOTA_EXCEEDED')||errorMsg.includes('quota')){
errorMsg='âŒ API í• ë‹¹ëŸ‰ ì´ˆê³¼\n\në¬´ë£Œ í•œë„:\n- ë¶„ë‹¹ 15íšŒ\n- ì¼ë‹¹ 1,500íšŒ\n\n1ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜\nê²°ì œ ê³„ì •ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”.';
}
}catch(e){
errorMsg='ì„œë²„ ì‘ë‹µ:\n'+errorText.substring(0,500);
}
throw new Error(errorMsg);
}

const result=await response.json();
console.log('âœ… API ì‘ë‹µ ë°›ìŒ:',result);

if(!result.candidates||result.candidates.length===0){
console.error('âŒ candidates ì—†ìŒ:',result);
if(result.promptFeedback){
console.error('âŒ í”„ë¡¬í”„íŠ¸ í”¼ë“œë°±:',result.promptFeedback);
throw new Error('í”„ë¡¬í”„íŠ¸ê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤: '+JSON.stringify(result.promptFeedback));
}
throw new Error('AIê°€ ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
}

const candidate=result.candidates[0];
console.log('ğŸ“„ Candidate:',candidate);

if(candidate.finishReason==='SAFETY'){
console.error('âŒ ì•ˆì „ í•„í„° ì°¨ë‹¨:',candidate.safetyRatings);
throw new Error('ì•ˆì „ í•„í„° ì°¨ë‹¨\n\ní”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”.');
}

if(!candidate.content||!candidate.content.parts||candidate.content.parts.length===0){
console.error('âŒ content ì—†ìŒ:',candidate);
throw new Error('ë¹ˆ ì‘ë‹µì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

const text=candidate.content.parts[0].text;
console.log('âœ…âœ…âœ… ìƒì„± ì„±ê³µ! âœ…âœ…âœ…');
console.log('ğŸ¯ ì‚¬ìš©ëœ ëª¨ë¸:',modelName);
console.log('ğŸ“ ìƒì„±ëœ í…ìŠ¤íŠ¸ ê¸¸ì´:',text.length,'ì');
console.log('ğŸ“ ìƒì„±ëœ í…ìŠ¤íŠ¸ (ì²˜ìŒ 100ì):',text.substring(0,100));
return text;

}catch(error){
console.error('âŒâŒâŒ ì „ì²´ ì—ëŸ¬ âŒâŒâŒ');
console.error('ì—ëŸ¬ íƒ€ì…:',error.constructor.name);
console.error('ì—ëŸ¬ ë©”ì‹œì§€:',error.message);
console.error('ì—ëŸ¬ ìŠ¤íƒ:',error.stack);
alert('ğŸš¨ AI ìƒì„± ì˜¤ë¥˜\n\n'+error.message+'\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\në°˜ë“œì‹œ F12 ëˆŒëŸ¬ì„œ\nì½˜ì†” íƒ­ì„ í™•ì¸í•˜ì„¸ìš”!\n\në¹¨ê°„ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼\nìº¡ì²˜í•´ì„œ ë³´ë‚´ì£¼ì„¸ìš”.');
return null;
}
}

function goToStep(step){
if(currentStep===1&&step>1){
if(!data.step1.prodType||!data.step1.vidLen||!data.step1.world){
alert('ëª¨ë“  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');return;
}
}
if(currentStep===3)saveChars();
currentStep=step;
document.querySelectorAll('.step-container').forEach(c=>c.classList.remove('active'));
document.querySelector(`.step-container[data-step="${step}"]`).classList.add('active');
document.querySelectorAll('.step-item').forEach(i=>{
i.classList.remove('active');
if(parseInt(i.dataset.step)===step)i.classList.add('active');
});
updateProgress();
window.scrollTo(0,0);
}

function updateProgress(){
const p=(currentStep/9)*100;
document.getElementById('progressFill').style.width=p+'%';
document.getElementById('progressText').textContent=`${currentStep}/9 ë‹¨ê³„ (${Math.round(p)}%)`;
}

function setupButtons(){
['productionType','videoLength','worldview'].forEach(id=>{
document.querySelectorAll(`#${id} .selection-button`).forEach(btn=>{
btn.addEventListener('click',()=>{
document.querySelectorAll(`#${id} .selection-button`).forEach(b=>b.classList.remove('selected'));
btn.classList.add('selected');
if(id==='productionType')data.step1.prodType=btn.dataset.value;
else if(id==='videoLength')data.step1.vidLen=btn.dataset.value;
else data.step1.world=btn.dataset.value;
saveData();
});
});
});
}

function setupSidebar(){
document.querySelectorAll('.step-item').forEach(i=>{
i.addEventListener('click',()=>goToStep(parseInt(i.dataset.step)));
});
}

function setupUploads(){
setupUpload('mainUpload','mainFile',(f)=>{
const r=new FileReader();
r.onload=(e)=>{
data.step5.mainChar.ref=e.target.result;
document.getElementById('mainPreview').classList.remove('hidden');
document.getElementById('mainImg').src=e.target.result;
saveData();
};
r.readAsDataURL(f);
});
setupUpload('toneUpload','toneFile',(f)=>{
const r=new FileReader();
r.onload=(e)=>{
data.step8.tone.data=e.target.result;
data.step8.tone.id='TONE_001';
document.getElementById('tonePreview').classList.remove('hidden');
document.getElementById('toneImg').src=e.target.result;
document.getElementById('toneToggle').classList.add('active');
data.step8.tone.match=true;
document.getElementById('toneLabel').textContent='Auto Match: ON';
saveData();
};
r.readAsDataURL(f);
});
document.getElementById('toneToggle').addEventListener('click',()=>{
const t=document.getElementById('toneToggle');
t.classList.toggle('active');
data.step8.tone.match=t.classList.contains('active');
document.getElementById('toneLabel').textContent=data.step8.tone.match?'Auto Match: ON':'Auto Match: OFF';
saveData();
});
}

function setupUpload(areaId,inputId,callback){
const area=document.getElementById(areaId);
const input=document.getElementById(inputId);
area.addEventListener('click',()=>input.click());
area.addEventListener('dragover',e=>{e.preventDefault();area.classList.add('dragover')});
area.addEventListener('dragleave',()=>area.classList.remove('dragover'));
area.addEventListener('drop',e=>{
e.preventDefault();
area.classList.remove('dragover');
if(e.dataTransfer.files.length>0)callback(e.dataTransfer.files[0]);
});
input.addEventListener('change',e=>{
if(e.target.files.length>0)callback(e.target.files[0]);
});
}

function addCharacter(){
const id=charCounter++;
const card=document.createElement('div');
card.className='character-card';
card.id=`char-${id}`;
card.innerHTML=`
<div class="character-card-header">
<div class="card-title">ìºë¦­í„° ${id+1}</div>
<div style="display:flex;gap:8px">
<button class="btn btn-generate" style="padding:6px 14px;font-size:12px" onclick="generateCharacter(${id})">ğŸ¤– AI ìƒì„±</button>
<button class="remove-btn" onclick="removeChar(${id})">ì‚­ì œ</button>
</div>
</div>
<div class="input-row">
<div><label>ì´ë¦„</label><input type="text" class="input-field" id="charName-${id}" oninput="saveChars()"></div>
<div><label>ì„±ë³„</label>
<select class="input-field" id="charGender-${id}" onchange="saveChars()">
<option value="">ì„ íƒ</option><option value="ì—¬ì„±">ì—¬ì„±</option><option value="ë‚¨ì„±">ë‚¨ì„±</option><option value="ë¬´ì„±">ë¬´ì„±</option>
</select></div>
</div>
<div class="input-row">
<div><label>ì¢…ì¡±</label>
<select class="input-field" id="charSpecies-${id}" onchange="saveChars()">
<option value="">ì„ íƒ</option><option value="ì¸ê°„">ì¸ê°„</option><option value="ë™ë¬¼">ë™ë¬¼</option><option value="ê·¸ ì™¸">ê·¸ ì™¸</option>
</select></div>
<div><label>ì—­í• </label>
<select class="input-field" id="charRole-${id}" onchange="saveChars()">
<option value="">ì„ íƒ</option><option value="ì£¼ì¸ê³µ">ì£¼ì¸ê³µ</option><option value="ì¡°ì—°">ì¡°ì—°</option><option value="ì•…ì—­">ì•…ì—­</option><option value="ê¸°íƒ€">ê¸°íƒ€</option>
</select></div>
</div>
<div><label>ìºë¦­í„° ì„¤ì •</label>
<textarea class="input-field" id="charDesc-${id}" maxlength="3000" oninput="saveChars()"></textarea></div>
<div style="margin-top:15px"><label>ì•ˆí‹° í¬ìŠ¤</label>
<div class="toggle-group">
<button class="toggle-btn active" onclick="toggleAnti(${id},false)">ì—†ìŒ</button>
<button class="toggle-btn" onclick="toggleAnti(${id},true)">ìˆìŒ</button>
</div>
<div class="anti-force-container hidden" id="anti-${id}">
<div class="checkbox-group">
<div class="checkbox-item"><input type="checkbox" id="af-vil-${id}" onchange="saveChars()"><label>ì•…ì—­</label></div>
<div class="checkbox-item"><input type="checkbox" id="af-dis-${id}" onchange="saveChars()"><label>ìì—°ì¬í•´</label></div>
<div class="checkbox-item"><input type="checkbox" id="af-org-${id}" onchange="saveChars()"><label>ë‹¨ì²´ ê¸°ê´€</label></div>
<div class="checkbox-item"><input type="checkbox" id="af-sys-${id}" onchange="saveChars()"><label>ì‹œìŠ¤í…œ</label></div>
<div class="checkbox-item"><input type="checkbox" id="af-ill-${id}" onchange="saveChars()"><label>ì§ˆë³‘</label></div>
<div class="checkbox-item"><input type="checkbox" id="af-tra-${id}" onchange="saveChars()"><label>íŠ¸ë¼ìš°ë§ˆ</label></div>
<div class="checkbox-item"><input type="checkbox" id="af-oth-${id}" onchange="saveChars()"><label>ê¸°íƒ€</label></div>
</div>
<input type="text" class="input-field" id="af-other-${id}" placeholder="ê¸°íƒ€ ë‚´ìš©" style="margin-top:10px" oninput="saveChars()">
</div></div>
`;
document.getElementById('charactersContainer').appendChild(card);
}

function removeChar(id){
document.getElementById(`char-${id}`).remove();
saveChars();
}

function toggleAnti(id,has){
const btns=document.querySelectorAll(`#char-${id} .toggle-btn`);
btns.forEach(b=>b.classList.remove('active'));
btns[has?1:0].classList.add('active');
const cont=document.getElementById(`anti-${id}`);
if(has)cont.classList.remove('hidden');
else cont.classList.add('hidden');
saveChars();
}

async function generateCharacter(id){
showLoading();
const plot=data.step2.plot||'ì¤„ê±°ë¦¬ ì—†ìŒ';
const worldDesc=data.step2.worldDesc||'ì„¸ê³„ê´€ ì—†ìŒ';
const charNum=id+1;

const prompt=`ë‹¹ì‹ ì€ ì „ë¬¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìºë¦­í„°ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

[ì‘í’ˆ ì •ë³´]
- ì¤„ê±°ë¦¬: ${plot}
- ì„¸ê³„ê´€: ${worldDesc}

[ìºë¦­í„° ë²ˆí˜¸]
${charNum}ë²ˆì§¸ ìºë¦­í„° (1ë²ˆ=ì£¼ì¸ê³µ, 2ë²ˆ ì´ìƒ=ì¡°ì—°/ì•…ì—­)

[ìš”êµ¬ì‚¬í•­]
ë‹¤ìŒ í˜•ì‹ì˜ JSONìœ¼ë¡œë§Œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
{
  "name": "ìºë¦­í„° ì´ë¦„ (í•œê¸€)",
  "gender": "ì—¬ì„± ë˜ëŠ” ë‚¨ì„± ë˜ëŠ” ë¬´ì„±",
  "species": "ì¸ê°„ ë˜ëŠ” ë™ë¬¼ ë˜ëŠ” ê·¸ ì™¸",
  "role": "ì£¼ì¸ê³µ ë˜ëŠ” ì¡°ì—° ë˜ëŠ” ì•…ì—­",
  "desc": "ìºë¦­í„° ìƒì„¸ ì„¤ëª… (ì™¸ëª¨, ì„±ê²©, ë°°ê²½, ìŠµê´€, íŠ¹ì§• ë“± 500-800ì)",
  "hasAnti": true ë˜ëŠ” false,
  "antiForce": ["vil", "dis", "org", "sys", "ill", "tra", "oth"] ì¤‘ í•´ë‹¹í•˜ëŠ” ê²ƒë“¤,
  "antiOther": "ê¸°íƒ€ ì•ˆí‹°í¬ìŠ¤ ì„¤ëª…"
}

JSONë§Œ ì¶œë ¥í•˜ê³  ë‹¤ë¥¸ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;

const result=await callGeminiAPI(prompt);
if(result){
try{
const cleaned=result.replace(/```json\n?/g,'').replace(/```\n?/g,'').trim();
const char=JSON.parse(cleaned);
document.getElementById(`charName-${id}`).value=char.name||'';
document.getElementById(`charGender-${id}`).value=char.gender||'';
document.getElementById(`charSpecies-${id}`).value=char.species||'';
document.getElementById(`charRole-${id}`).value=char.role||'';
document.getElementById(`charDesc-${id}`).value=char.desc||'';
toggleAnti(id,char.hasAnti||false);
if(char.hasAnti&&char.antiForce){
char.antiForce.forEach(f=>{
const checkbox=document.getElementById(`af-${f}-${id}`);
if(checkbox)checkbox.checked=true;
});
if(char.antiOther)document.getElementById(`af-other-${id}`).value=char.antiOther;
}
saveChars();
}catch(e){
alert('ìºë¦­í„° ìƒì„± ì˜¤ë¥˜: JSON íŒŒì‹± ì‹¤íŒ¨');
console.error(e,result);
}
}
hideLoading();
}

function saveChars(){
const chars=[];
document.querySelectorAll('.character-card').forEach(card=>{
const id=card.id.split('-')[1];
const anti=!document.getElementById(`anti-${id}`).classList.contains('hidden');
const antiForce=[];
['vil','dis','org','sys','ill','tra','oth'].forEach(t=>{
if(document.getElementById(`af-${t}-${id}`)?.checked)antiForce.push(t);
});
chars.push({
name:document.getElementById(`charName-${id}`)?.value||'',
gender:document.getElementById(`charGender-${id}`)?.value||'',
species:document.getElementById(`charSpecies-${id}`)?.value||'',
role:document.getElementById(`charRole-${id}`)?.value||'',
desc:document.getElementById(`charDesc-${id}`)?.value||'',
anti:anti,
antiForce:antiForce,
antiOther:document.getElementById(`af-other-${id}`)?.value||''
});
});
data.step3.chars=chars;
saveData();
}

async function generate5Acts(){
showLoading();
const plot=data.step2.plot||'ì¤„ê±°ë¦¬ ì—†ìŒ';
const worldDesc=data.step2.worldDesc||'ì„¸ê³„ê´€ ì—†ìŒ';
const videoLength=data.step1.vidLen||'10ë¶„';
const chars=data.step3.chars||[];
const charInfo=chars.map(c=>`${c.name}(${c.role})`).join(', ')||'ìºë¦­í„° ì—†ìŒ';

const prompt=`ë‹¹ì‹ ì€ ì „ë¬¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ 5ë§‰ êµ¬ì¡°ë¥¼ ìƒì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì‘í’ˆ ì •ë³´]
- ì˜ìƒ ê¸¸ì´: ${videoLength}
- ì¤„ê±°ë¦¬: ${plot}
- ì„¸ê³„ê´€: ${worldDesc}
- ì£¼ìš” ìºë¦­í„°: ${charInfo}

[ìš”êµ¬ì‚¬í•­]
5ë§‰ êµ¬ì¡°ë¥¼ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. ê° ë§‰ì€ 600-1000ì ë¶„ëŸ‰:

1. Act 1 (ë°œë‹¨ - Setup):
   - ì‹œê°„ í‘œì‹œ í¬í•¨
   - ì£¼ì¸ê³µê³¼ ì¼ìƒ ì†Œê°œ
   - ì‚¬ê±´ì˜ ë°œë‹¨ (í›„í‚¹ í¬ì¸íŠ¸)

2. Act 2 (ì „ê°œ - Development):
   - ìƒˆë¡œìš´ ì„¸ê³„ ì§„ì…
   - ì¡°ë ¥ì/ì ëŒ€ì ë“±ì¥
   - ëª©í‘œ ì„¤ì •

3. Act 3 (ìœ„ê¸° - Crisis):
   - ìµœëŒ€ ìœ„ê¸° ìƒí™©
   - ì£¼ì¸ê³µì˜ ê³ ë¯¼ê³¼ ê°ˆë“±
   - ëª¨ë“  ê²ƒì´ ë¬´ë„ˆì§€ëŠ” ìˆœê°„

4. Act 4 (í´ë¼ì´ë§¥ìŠ¤ - Climax):
   - ë°˜ì „ ìš”ì†Œ
   - ë¬¸ì œ í•´ê²° ì‹œë„
   - ê°ë™ì  ìˆœê°„

5. Act 5 (ê²°ë§ - Resolution):
   - ë³€í™”í•œ ì£¼ì¸ê³µ
   - ìƒˆë¡œìš´ ì¼ìƒ
   - ì—¬ìš´ê³¼ ë©”ì‹œì§€

ê° ë§‰ì„ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•˜ê³ , êµ¬ì²´ì ì´ê³  ìƒì„¸í•˜ê²Œ ë¬˜ì‚¬í•´ì£¼ì„¸ìš”.`;

const result=await callGeminiAPI(prompt);
if(result){
const acts=result.split(/Act\s*[1-5]|â‘ |â‘¡|â‘¢|â‘£|â‘¤|\d+\./i).filter(s=>s.trim());
if(acts.length>=5){
document.getElementById('act1').value=acts[0].trim();
document.getElementById('act2').value=acts[1].trim();
document.getElementById('act3').value=acts[2].trim();
document.getElementById('act4').value=acts[3].trim();
document.getElementById('act5').value=acts[4].trim();
}else{
const parts=result.split('\n\n');
const actTexts=['','','','',''];
let currentAct=-1;
parts.forEach(part=>{
if(part.match(/ë°œë‹¨|setup|act\s*1/i))currentAct=0;
else if(part.match(/ì „ê°œ|development|act\s*2/i))currentAct=1;
else if(part.match(/ìœ„ê¸°|crisis|act\s*3/i))currentAct=2;
else if(part.match(/í´ë¼ì´ë§¥ìŠ¤|climax|act\s*4/i))currentAct=3;
else if(part.match(/ê²°ë§|resolution|act\s*5/i))currentAct=4;
else if(currentAct>=0)actTexts[currentAct]+=(actTexts[currentAct]?'\n\n':'')+part;
});
for(let i=0;i<5;i++){
if(actTexts[i])document.getElementById(`act${i+1}`).value=actTexts[i].trim();
}
}
saveData();
alert('5ë§‰ êµ¬ì¡° ìƒì„± ì™„ë£Œ!');
}
hideLoading();
}

function generateMainChar(){
if(!data.step5.mainChar.ref){alert('ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”');return;}
const grid=document.getElementById('mainGrid');
grid.innerHTML='';
[...CHAR_POSES,...CHAR_EXPRS].forEach(item=>{
genImgCard(grid,item.id,item.label,'main');
});
saveData();
}

function genImgCard(container,id,label,type){
const card=document.createElement('div');
card.className='image-card';
card.innerHTML=`
<div class="image-preview generating" id="${type}-${id}-preview">
<div style="color:#999;font-size:12px">ìƒì„± ì¤‘...</div>
</div>
<div class="image-label">${label}</div>
<div class="image-actions">
<button class="icon-btn" onclick="viewImg('${type}-${id}')">ğŸ‘ï¸</button>
<button class="icon-btn" onclick="downloadImg('${type}-${id}')">ğŸ’¾</button>
<button class="icon-btn" onclick="regenImg('${type}-${id}')">ğŸ”„</button>
</div>
`;
container.appendChild(card);
setTimeout(()=>{
const preview=document.getElementById(`${type}-${id}-preview`);
preview.classList.remove('generating');
preview.innerHTML=`<img src="https://via.placeholder.com/180x180/A56744/FFF?text=${label}" alt="${label}">`;
},2000);
}

function viewImg(id){
const preview=document.getElementById(`${id}-preview`);
const img=preview.querySelector('img');
if(img){
document.getElementById('modalImg').src=img.src;
document.getElementById('modal').classList.add('active');
}
}

function downloadImg(id){
const preview=document.getElementById(`${id}-preview`);
const img=preview.querySelector('img');
if(img){
const a=document.createElement('a');
a.href=img.src;
a.download=`${id}.png`;
a.click();
}
}

function regenImg(id){
const preview=document.getElementById(`${id}-preview`);
preview.classList.add('generating');
preview.innerHTML='<div style="color:#999;font-size:12px">ì¬ìƒì„± ì¤‘...</div>';
setTimeout(()=>{
preview.classList.remove('generating');
const label=preview.parentElement.querySelector('.image-label').textContent;
preview.innerHTML=`<img src="https://via.placeholder.com/180x180/A56744/FFF?text=${label}" alt="${label}">`;
},2000);
}

function downloadAllImages(type){alert('ì „ì²´ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ');}

function closeModal(){document.getElementById('modal').classList.remove('active');}

function addSubCharacter(){
const id=subCharCounter++;
const card=document.createElement('div');
card.className='character-card';
card.id=`subchar-${id}`;
card.innerHTML=`
<div class="character-card-header">
<div class="card-title">ì¶”ê°€ ìºë¦­í„° ${id+1}</div>
<button class="remove-btn" onclick="removeSub(${id})">ì‚­ì œ</button>
</div>
<div class="input-row">
<div><label>ì´ë¦„</label>
<div class="input-with-button">
<input type="text" class="input-field" id="subName-${id}">
<button class="random-btn" onclick="genName(${id})">ğŸ²</button>
</div></div>
</div>
<div class="upload-area" id="subUpload-${id}">
<div style="font-size:32px">ğŸ“·</div><p>ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€</p>
<input type="file" accept="image/*" id="subFile-${id}">
</div>
<button class="btn btn-generate" onclick="genSubChar(${id})">ğŸ² ì‹œíŠ¸ ìƒì„±</button>
<div class="image-grid" id="subGrid-${id}"></div>
`;
document.getElementById('subCharsContainer').appendChild(card);
setupUpload(`subUpload-${id}`,`subFile-${id}`,()=>{});
}

function removeSub(id){document.getElementById(`subchar-${id}`).remove();}
function genName(id){
const names=['ì§€ìš°','ì„œì¤€','í•˜ì€','ë¯¼ì„œ','ë„ìœ¤'];
document.getElementById(`subName-${id}`).value=names[Math.floor(Math.random()*names.length)];
}
function genSubChar(id){
const grid=document.getElementById(`subGrid-${id}`);
grid.innerHTML='';
[...CHAR_POSES,...CHAR_EXPRS].forEach(item=>genImgCard(grid,item.id,item.label,`sub${id}`));
}

function addBackground(){
const id=bgCounter++;
const card=document.createElement('div');
card.className='bg-card';
card.id=`bg-${id}`;
card.innerHTML=`
<div class="bg-card-header">
<div class="card-title">ë°°ê²½ ${id+1}</div>
<button class="remove-btn" onclick="removeBg(${id})">ì‚­ì œ</button>
</div>
<div><label>ì¥ì†Œ ì´ë¦„ (í•„ìˆ˜)</label>
<input type="text" class="input-field" id="bgName-${id}" placeholder="ì˜ˆ: í•™êµ êµì‹¤"></div>
<div class="upload-area" id="bgUpload-${id}" style="margin-top:10px">
<div style="font-size:32px">ğŸï¸</div><p>ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€</p>
<input type="file" accept="image/*" id="bgFile-${id}">
</div>
<button class="btn btn-generate" onclick="genBg(${id})">ğŸ² 6ê°œ ì‹œì  ìƒì„±</button>
<div class="image-grid" id="bgGrid-${id}"></div>
`;
document.getElementById('backgroundsContainer').appendChild(card);
setupUpload(`bgUpload-${id}`,`bgFile-${id}`,()=>{});
}

function removeBg(id){document.getElementById(`bg-${id}`).remove();}
function genBg(id){
const name=document.getElementById(`bgName-${id}`).value;
if(!name){alert('ì¥ì†Œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
const grid=document.getElementById(`bgGrid-${id}`);
grid.innerHTML='';
BG_VIEWS.forEach(v=>genImgCard(grid,v.id,v.label,`bg${id}`));
}

function autoGenCuesheet(){
if(confirm('AIê°€ íì‹œíŠ¸ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
for(let i=0;i<3;i++)addScene();
alert('íì‹œíŠ¸ ìƒì„± ì™„ë£Œ!');
}
}

function addScene(){
const id=sceneCounter++;
const start=id*10;
const end=start+10;
const scene=document.createElement('div');
scene.className='scene-accordion';
scene.id=`scene-${id}`;
scene.innerHTML=`
<div class="scene-header" onclick="toggleScene(${id})">
<div><strong>ì”¨ ${id+1}</strong> <span style="font-size:12px;color:#666;margin-left:10px">${fmtTime(start)} - ${fmtTime(end)}</span></div>
<span>â–¼</span>
</div>
<div class="scene-content" id="sceneContent-${id}">
<div id="shots-${id}"></div>
<button class="add-btn" onclick="addShot(${id})">+ ìƒ· ì¶”ê°€</button>
</div>
`;
document.getElementById('scenesContainer').appendChild(scene);
addShot(id);
}

function toggleScene(id){
const header=document.querySelector(`#scene-${id} .scene-header`);
const content=document.getElementById(`sceneContent-${id}`);
header.classList.toggle('active');
content.classList.toggle('active');
}

function addShot(sceneId){
const shotId=shotCounter++;
const card=document.createElement('div');
card.className='shot-card';
card.id=`shot-${shotId}`;
card.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #e0e0e0">
<strong style="color:#A56744">ìƒ· ${shotId+1}</strong>
<button class="remove-btn" onclick="removeShot(${sceneId},${shotId})">ì‚­ì œ</button>
</div>
<div class="key-image-preview" onclick="viewKeyImg(${shotId})" id="keyPrev-${shotId}">
<div style="text-align:center;color:#999">
<div style="font-size:40px">ğŸ–¼ï¸</div>
<p style="font-size:12px">KEY ì´ë¯¸ì§€ ìƒì„±</p>
</div>
</div>
<div class="auto-prompt hidden" id="autoPrompt-${shotId}">
<strong>ğŸ¤– ìë™ í”„ë¡¬í”„íŠ¸</strong>
<div id="autoPromptText-${shotId}" style="margin-top:5px;font-family:monospace"></div>
</div>
<h4 style="margin-bottom:10px;color:#A56744">6ì„¹ì…˜ í”„ë¡¬í”„íŠ¸</h4>
<div class="prompt-grid">
<div class="prompt-section">
<div class="prompt-label">[ì¥ë©´] ë°°ê²½/ì‹œê°„/ê³µê°„</div>
<textarea class="prompt-input" id="ps-${shotId}" placeholder="ì˜ˆ: ë°ì€ ì‹¤ë‚´..."></textarea>
</div>
<div class="prompt-section">
<div class="prompt-label">[í”¼ì‚¬ì²´] ì£¼ìš” ëŒ€ìƒ</div>
<textarea class="prompt-input" id="ps2-${shotId}" placeholder="ì˜ˆ: ì£¼ì¸ê³µ..."></textarea>
</div>
<div class="prompt-section">
<div class="prompt-label">[ì¹´ë©”ë¼] êµ¬ë„/ì•µê¸€</div>
<textarea class="prompt-input" id="ps3-${shotId}" placeholder="ì˜ˆ: ë¡œìš°ì•µê¸€..."></textarea>
</div>
<div class="prompt-section">
<div class="prompt-label">[ì¡°ëª…] ë¹›/ìƒ‰ê°</div>
<textarea class="prompt-input" id="ps4-${shotId}" placeholder="ì˜ˆ: ìì—°ê´‘..."></textarea>
</div>
<div class="prompt-section">
<div class="prompt-label">[ë¶„ìœ„ê¸°] ê°ì •/ë¬´ë“œ</div>
<textarea class="prompt-input" id="ps5-${shotId}" placeholder="ì˜ˆ: ë”°ëœ»í•¨..."></textarea>
</div>
<div class="prompt-section">
<div class="prompt-label">[ìŠ¤íƒ€ì¼] ë Œë”ë§</div>
<textarea class="prompt-input" id="ps6-${shotId}" placeholder="ì˜ˆ: ì‹œë„¤ë§ˆí‹±..."></textarea>
</div>
</div>
<div class="button-group" style="margin-top:12px">
<button class="btn btn-generate" onclick="genKeyImg(${shotId})">ğŸ¨ KEY ì´ë¯¸ì§€ ìƒì„±</button>
<button class="btn btn-secondary" onclick="regenKeyImg(${shotId})">ğŸ”„</button>
</div>
`;
document.getElementById(`shots-${sceneId}`).appendChild(card);
}

function removeShot(sceneId,shotId){
document.getElementById(`shot-${shotId}`).remove();
}

function genKeyImg(shotId){
const prompts=[1,2,3,4,5,6].map(i=>document.getElementById(`ps${i===1?'':i}-${shotId}`).value).filter(p=>p).join(', ');
const autoP=prompts+', high resolution, ultra detailed, best quality';
if(data.step8.tone.match&&data.step8.tone.id)autoP+=`\n\n[Meta]\nTONEREF_ID: ${data.step8.tone.id}\nmatch_tone: true`;
document.getElementById('autoPrompt-${shotId}').classList.remove('hidden');
document.getElementById('autoPromptText-${shotId}').textContent=autoP;
const preview=document.getElementById(`keyPrev-${shotId}`);
preview.innerHTML='<div class="generating"></div>';
setTimeout(()=>{
preview.innerHTML=`<img src="https://via.placeholder.com/800x450/A56744/FFF?text=KEY+Image" alt="KEY">`;
},2000);
}

function regenKeyImg(shotId){genKeyImg(shotId);}
function viewKeyImg(shotId){
const img=document.querySelector(`#keyPrev-${shotId} img`);
if(img){
document.getElementById('modalImg').src=img.src;
document.getElementById('modal').classList.add('active');
}
}

async function autoGenPlan(){
showLoading();
const plot=data.step2.plot||'';
const worldDesc=data.step2.worldDesc||'';
const act1=data.step4.act1||'';
const act2=data.step4.act2||'';
const act3=data.step4.act3||'';
const act4=data.step4.act4||'';
const act5=data.step4.act5||'';
const chars=data.step3.chars||[];
const charInfo=chars.map(c=>`${c.name}(${c.role}): ${c.desc}`).join('\n')||'';

const prompt=`ë‹¹ì‹ ì€ ì „ë¬¸ ì˜í™” ê¸°íšìì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì˜í™” ê¸°íšì•ˆì„ ì‘ì„±í•˜ì„¸ìš”.

[ì‘í’ˆ ì •ë³´]
ì¤„ê±°ë¦¬: ${plot}
ì„¸ê³„ê´€: ${worldDesc}
ìºë¦­í„°: ${charInfo}
5ë§‰ êµ¬ì¡°:
- Act1: ${act1}
- Act2: ${act2}
- Act3: ${act3}
- Act4: ${act4}
- Act5: ${act5}

ë‹¤ìŒ 5ê°œ í•­ëª©ì„ ê°ê° ì‘ì„±í•´ì£¼ì„¸ìš”:

1. Hook (1ì¤„, 200ì ì´ë‚´):
ì‘í’ˆì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ

2. Logline (3-5ì¤„, 500ì ì´ë‚´):
ì£¼ì¸ê³µ, ê°ˆë“±, ëª©í‘œ, í•´ê²°ì„ í¬í•¨í•œ 3-5ë¬¸ì¥ ìš”ì•½

3. Synopsis (1500ì):
5ë§‰ êµ¬ì¡°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ì²´ ìŠ¤í† ë¦¬ë¥¼ ìƒì„¸íˆ ìš”ì•½. ê° ë§‰ì˜ ì£¼ìš” ì‚¬ê±´ í¬í•¨

4. ìºë¦­í„° ì•„ì¹˜ (1000ì):
ì£¼ì¸ê³µì˜ ë³€í™” ê³¼ì •ì„ 5ë‹¨ê³„ë¡œ ë¶„ì„:
- ì‹œì‘ì 
- ì „í™˜ì 1
- ìµœì €ì 
- ë³€í™”ì˜ ìˆœê°„
- ë„ì°©ì 

5. ì‹œì¥ì„±/íƒ€ê²Ÿ/ê²½ìŸì‘ (1200ì):
- íƒ€ê²Ÿ ê´€ê° (ì—°ë ¹, ì„±ë³„, íŠ¹ì„±)
- ì‹œì¥ì„± ë¶„ì„ (íŠ¸ë Œë“œ, ì°¨ë³„í™”)
- ê²½ìŸì‘ ë¹„êµ
- ê¸°ëŒ€ íš¨ê³¼

ê° í•­ëª©ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.`;

const result=await callGeminiAPI(prompt);
if(result){
const sections={hook:'',logline:'',synopsis:'',charArch:'',market:''};
const lines=result.split('\n');
let currentSection='';

lines.forEach(line=>{
if(line.match(/hook|í›…/i)&&!sections.hook)currentSection='hook';
else if(line.match(/logline|ë¡œê·¸ë¼ì¸/i)&&!sections.logline)currentSection='logline';
else if(line.match(/synopsis|ì‹œë†‰ì‹œìŠ¤/i)&&!sections.synopsis)currentSection='synopsis';
else if(line.match(/ìºë¦­í„°\s*ì•„ì¹˜|character\s*arc/i)&&!sections.charArch)currentSection='charArch';
else if(line.match(/ì‹œì¥|market|íƒ€ê²Ÿ/i)&&!sections.market)currentSection='market';
else if(currentSection&&line.trim()&&!line.match(/^[#*\-\d]/)){
sections[currentSection]+=(sections[currentSection]?'\n':'')+line;
}
});

if(sections.hook)document.getElementById('hook').value=sections.hook.trim();
if(sections.logline)document.getElementById('logline').value=sections.logline.trim();
if(sections.synopsis)document.getElementById('synopsis').value=sections.synopsis.trim();
if(sections.charArch)document.getElementById('charArch').value=sections.charArch.trim();
if(sections.market)document.getElementById('market').value=sections.market.trim();

saveData();
alert('AI ìë™ ìƒì„± ì™„ë£Œ!');
}
hideLoading();
}

function toggleAcc(i){
const items=document.querySelectorAll('.accordion-item');
const header=items[i].querySelector('.accordion-header');
const content=items[i].querySelector('.accordion-content');
header.classList.toggle('active');
content.classList.toggle('active');
}

function updateCounter(fieldId,countId,max){
const field=document.getElementById(fieldId);
const count=document.getElementById(countId);
if(field&&count)count.textContent=`${field.value.length}/${max}`;
saveData();
}

function generateTitle(){
const titles=['ë³„ì„ ì°¾ì•„ì„œ','ì‘ì€ ì™•ìì˜ ì—¬í–‰','ìš°ì£¼ì˜ ì •ì›ì‚¬'];
document.getElementById('title').value=titles[Math.floor(Math.random()*titles.length)];
saveData();
}

async function generatePlot(){
showLoading();
const title=document.getElementById('title').value||'ì œëª© ë¯¸ì •';
const worldview=data.step1.world||'ì¼ë°˜';
const videoLength=data.step1.vidLen||'ë¯¸ì •';
const productionType=data.step1.prodType||'ì˜í™”';

const prompt=`ë‹¹ì‹ ì€ ì „ë¬¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì˜í™”/ì• ë‹ˆë©”ì´ì…˜ì˜ ì¤„ê±°ë¦¬ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ê¸°ë³¸ ì •ë³´]
- ì œëª©: ${title}
- ì œì‘ í˜•íƒœ: ${productionType}
- ì˜ìƒ ê¸¸ì´: ${videoLength}
- ì„¸ê³„ê´€: ${worldview}

[ìš”êµ¬ì‚¬í•­]
1. ì¤„ê±°ë¦¬ëŠ” 400-600ì ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±
2. ëª…í™•í•œ ì‹œì‘, ì „ê°œ, í´ë¼ì´ë§¥ìŠ¤, ê²°ë§ êµ¬ì¡°
3. ì£¼ì¸ê³µì˜ ëª©í‘œì™€ ê°ˆë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œ
4. ê°ì •ì  ëª°ì…ì„ ìœ ë„í•˜ëŠ” ìŠ¤í† ë¦¬í…”ë§
5. ${worldview} ì„¸ê³„ê´€ì˜ íŠ¹ì„±ì„ ì˜ ë°˜ì˜

ì¤„ê±°ë¦¬ë§Œ ì‘ì„±í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ ìƒëµí•´ì£¼ì„¸ìš”.`;

const result=await callGeminiAPI(prompt);
if(result){
document.getElementById('plot').value=result.trim();
updateCounter('plot','plotCount',5000);
saveData();
}
hideLoading();
}

async function generateWorld(){
showLoading();
const title=document.getElementById('title').value||'ì œëª© ë¯¸ì •';
const plot=document.getElementById('plot').value||'ì¤„ê±°ë¦¬ ì—†ìŒ';
const worldview=data.step1.world||'ì¼ë°˜';
const productionType=data.step1.prodType||'ì˜í™”';

const prompt=`ë‹¹ì‹ ì€ ì „ë¬¸ ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤. ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‘í’ˆì˜ ì„¸ê³„ê´€ì„ ìƒì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ê¸°ë³¸ ì •ë³´]
- ì œëª©: ${title}
- ì œì‘ í˜•íƒœ: ${productionType}
- ì„¸ê³„ê´€ ìœ í˜•: ${worldview}
- ì¤„ê±°ë¦¬: ${plot}

[ìš”êµ¬ì‚¬í•­]
1. ì„¸ê³„ê´€ ì„¤ëª…ì€ 400-600ì ë¶„ëŸ‰
2. ì‹œê°„ì  ë°°ê²½ (ì‹œëŒ€, ì—°ë„ ë“±)
3. ê³µê°„ì  ë°°ê²½ (ì¥ì†Œ, ì§€ë¦¬ì  íŠ¹ì§•)
4. ì„¸ê³„ê´€ì˜ ë…íŠ¹í•œ ì„¤ì •ê³¼ ê·œì¹™
5. ì‚¬íšŒ êµ¬ì¡°, ë¬¸í™”, ê¸°ìˆ  ìˆ˜ì¤€ ë“±
6. ì¤„ê±°ë¦¬ì™€ ìì—°ìŠ¤ëŸ½ê²Œ ì—°ê²°ë˜ëŠ” ì„¸ê³„ê´€

ì„¸ê³„ê´€ ì„¤ëª…ë§Œ ì‘ì„±í•˜ê³ , ë‹¤ë¥¸ ë‚´ìš©ì€ ìƒëµí•´ì£¼ì„¸ìš”.`;

const result=await callGeminiAPI(prompt);
if(result){
document.getElementById('worldDesc').value=result.trim();
updateCounter('worldDesc','worldCount',5000);
saveData();
}
hideLoading();
}

function fmtTime(sec){
const m=Math.floor(sec/60);
const s=sec%60;
return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function saveData(){
if(document.getElementById('title')){
data.step2.title=document.getElementById('title').value;
data.step2.plot=document.getElementById('plot').value;
data.step2.worldDesc=document.getElementById('worldDesc').value;
}
if(document.getElementById('act1')){
data.step4.act1=document.getElementById('act1').value;
data.step4.act2=document.getElementById('act2').value;
data.step4.act3=document.getElementById('act3').value;
data.step4.act4=document.getElementById('act4').value;
data.step4.act5=document.getElementById('act5').value;
}
if(document.getElementById('hook')){
data.step9.hook=document.getElementById('hook').value;
data.step9.logline=document.getElementById('logline').value;
data.step9.synopsis=document.getElementById('synopsis').value;
data.step9.charArch=document.getElementById('charArch').value;
data.step9.market=document.getElementById('market').value;
data.step9.director=document.getElementById('director').value;
}
localStorage.setItem('videoWorkflow_pro',JSON.stringify(data));
showSave();
}

function loadData(){
const saved=localStorage.getItem('videoWorkflow_pro');
if(saved)data=JSON.parse(saved);
}

function showSave(){
const s=document.getElementById('saveStatus');
s.classList.add('show');
setTimeout(()=>s.classList.remove('show'),2000);
}

function showLoading(){document.getElementById('loading').classList.add('active');}
function hideLoading(){document.getElementById('loading').classList.remove('active');}

function downloadWord(){alert(`${currentStep}ë‹¨ê³„ê¹Œì§€ ì›Œë“œ ë‹¤ìš´ë¡œë“œ`);}
function downloadFinal(){alert('ì „ì²´ í†µí•© ì›Œë“œ ë‹¤ìš´ë¡œë“œ');}

document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')closeModal()});

init();
</script>
</body>
</html>